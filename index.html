<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tax Invoice Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>


body {
   font-family: 'Roboto', sans-serif;
   background: #f4f6f8;
   margin: 0;
   padding: 20px;
   color: #333;
   }
  
   h2 {
   text-align: center;
   color: #2c3e50;
   }
  
   fieldset {
   border: 1px solid #ccc;
   padding: 15px;
   margin-bottom: 20px;
   background: #fff;
   border-radius: 8px;
   }
  
   legend {
   font-weight: bold;
   color: #2c3e50;
   }
  
   label, input {
   display: block;
   margin: 10px 0;
   }
  
   input[type="text"],
   input[type="number"],
   input[type="date"] {
   width: 80%;
   padding: 8px;
   border: 1px solid #ccc;
   border-radius: 4px;
   }
  
   input[type="file"] {
   margin-top: 10px;
   }
  
   table {
   width: 100%;
   border-collapse: collapse;
   background: #fff;
   border-radius: 8px;
   overflow: hidden;
   }
  
   th, td {
   padding: 10px;
   border: 1px solid #ddd;
   text-align: center;
   }
  
   
th {
  background-color: rgba(255, 0, 0, 0.75); /* 75% opaque red */
  color: white;
}

  
   button {
   background-color: #3498db;
   color: white;
   padding: 10px 20px;
   border: none;
   border-radius: 5px;
   margin-top: 10px;
   cursor: pointer;
   }
  
   button:hover {
   background-color: #2980b9;
   }
  
   .container {
   max-width: 1000px;
   margin: auto;
   }
  
  </style>
</head>
<body>
  
<div class="container">
  <img src="Header.png" id="logo0" crossorigin="anonymous" style="display: none;">
  <img src="Stamp.png" id="stamp" crossorigin="anonymous" style="display: none;">

   <h2>Tax Invoice Generator</h2>
  
   <!-- <label>Upload Logo:
   <input type="file" id="logoInput" accept="image/*">
   </label><br><br> -->
   <fieldset>
    <legend><strong>Invoice Info</strong></legend>
    Invoice Number: <input type="text" id="invoiceNumber">
    Invoice Date: <input type="date" id="invoiceDate">
    Customer Code: <input type="text" id="customerCode">
    Due Date: <input type="date" id="invoiceDueDate">
    </fieldset>
  
   <fieldset>
   <legend><strong>Customer Info</strong></legend>
   Name: <input type="text" id="customerName">
   Address: <input type="text" id="customerAddress">
   Telephone: <input type="text" id="customerPhone">
   Email: <input type="text" id="customerEmail">
   TRN: <input type="text" id="customerTRN">
   </fieldset>
  
   <!--<fieldset>
   <legend><strong>Company Info</strong></legend>
   Company Name: <input type="text" id="companyName">
   Company Address: <input type="text" id="companyAddress">
   </fieldset>-->
  
   

   <fieldset>
    <legend><strong>Discount Info</strong></legend>
    Discount:  <input type="number" id="discount">
    </fieldset>
  
   <table id="itemsTable">
   <thead>
   <tr>
   <th>No</th>
   <th>Code</th>
   <th>Description</th>
   <th>Qty</th>
   <th>Price</th>
   <th>Total</th>
   <th>VAT 5%</th>
   <th>Net</th>
   <th>Action</th>
   </tr>
   </thead>
   <tbody id="itemsBody">
   <tr>
   <td>1</td>
   <td><input type="text" class="partNumber"></td>
   <td><input type="text" class="description"></td>
   <td><input type="number" class="qty" value="1"></td>
   <td><input type="number" class="price" value="0"></td>
   <td class="total">0</td>
   <td class="vat">0</td>
   <td class="inclVat">0</td>
   <td><button onclick="removeRow(this)">Remove</button></td>
   </tr>
   </tbody>
   </table>
  
   <button onclick="addRow()">Add Item</button><br><br>
   <button onclick="generateInvoice()">Generate Invoice PDF</button>
   </div>

   <img src="Picture1.png" id="logo1" crossorigin="anonymous"  style="display: none;">
   <img src="Picture2.png" id="logo2" crossorigin="anonymous"  style="display: none;">
   <img src="Picture3.png" id="logo3" crossorigin="anonymous"  style="display: none;">
   <img src="Picture4.png" id="logo4" crossorigin="anonymous"  style="display: none;">
   <img src="Picture5.png" id="logo5" crossorigin="anonymous"  style="display: none;">
   <img src="Picture6.png" id="logo6" crossorigin="anonymous"  style="display: none;">
   <img src="Picture7.png" id="logo7" crossorigin="anonymous"  style="display: none;">
   <img src="Picture8.png" id="logo8" crossorigin="anonymous"  style="display: none;">
  

  <script>


let customerData = [];

    window.addEventListener('DOMContentLoaded', () => {
      Papa.parse('codes.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          customerData = results.data;
          console.log('Customer data loaded:', customerData);
        }
      });
    });


document.getElementById('customerCode').addEventListener('input', function () {
  const code = this.value.trim();
  const customer = customerData.find(c => c['customerCode'] === code);
  if (customer) {
    document.getElementById('customerName').value = customer['customerName'] || '';
    document.getElementById('customerAddress').value = customer['customerAddress'] || '';
    document.getElementById('customerPhone').value = customer['customerPhone'] || '';
    document.getElementById('customerEmail').value = customer['customerEmail'] || '';
    document.getElementById('customerTRN').value = customer['customerTRN'] || '';
  }
});




    function toAEDWords(amount) {
      const ones = ['zero','one','two','three','four','five','six','seven','eight','nine',
        'ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
      const tens = ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];

      function chunkToWords(n){ // 0..999
        let s = '';
        const h = Math.floor(n/100), r = n%100;
        if (h) s += ones[h] + ' hundred' + (r ? ' ' : '');
        if (r < 20) { if (r) s += ones[r]; }
        else {
          const t = Math.floor(r/10), u = r%10;
          s += tens[t] + (u ? '-' + ones[u] : '');
        }
        return s;
      }
      function intToWords(n){ // up to trillions
        if (n === 0) return 'zero';
        const units = ['', ' thousand', ' million', ' billion', ' trillion'];
        let i = 0, words = [];
        while (n > 0) {
          const chunk = n % 1000;
          if (chunk) words.unshift(chunkToWords(chunk) + units[i]);
          n = Math.floor(n/1000); i++;
        }
        return words.join(' ');
      }

      const whole = Math.floor(Math.abs(amount));
      const fils  = Math.round((Math.abs(amount) - whole) * 100);

      let out = capitalize(intToWords(whole)) + ' dirhams';
      if (fils > 0) out += ' and ' + intToWords(fils) + ' fils';
      else out += ' only';
      return out;
    }
    function capitalize(s){ return s ? s[0].toUpperCase() + s.slice(1) : s; }

    function updateCalculations() {
      const rows = document.querySelectorAll('#itemsBody tr');
      rows.forEach(row => {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const total = qty * price;
        const vat = total * 0.05;
        const inclVat = total + vat;
    
        row.querySelector('.total').textContent = total.toFixed(2);
        row.querySelector('.vat').textContent = vat.toFixed(2);
        row.querySelector('.inclVat').textContent = inclVat.toFixed(2);
      });
    }
    
    // Attach event listeners to update calculations on input change
    document.addEventListener('input', function (e) {
      if (e.target.classList.contains('qty') || e.target.classList.contains('price')) {
        updateCalculations();
      }
    });
    
    function addRow() {
      const table = document.getElementById('itemsBody');
      const rowCount = table.rows.length + 1;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" class="partNumber"></td>
        <td><input type="text" class="description"></td>
        <td><input type="number" class="qty" value="1"></td>
        <td><input type="number" class="price" value="0"></td>
        <td class="total">0</td>
        <td class="vat">0</td>
        <td class="inclVat">0</td>
        <td><button onclick="removeRow(this)">Remove</button></td>
      `;
      table.appendChild(row);
    }

    function removeRow(button) {
      button.parentElement.parentElement.remove();
    }
    

    async function generateInvoice() {

      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const customer = {
        name: document.getElementById('customerName').value,
        address: document.getElementById('customerAddress').value,
        phone: document.getElementById('customerPhone').value,
        trn: document.getElementById('customerTRN').value,
        email: document.getElementById('customerEmail').value
      };

      /*const company = {
        name: document.getElementById('companyName').value,
        address: document.getElementById('companyAddress').value
      };*/

      const invoice = {
        number: document.getElementById('invoiceNumber').value,
        date: document.getElementById('invoiceDate').value,
        code: document.getElementById('customerCode').value,
        invoiceDueDate: document.getElementById('invoiceDueDate').value
      };

      const discountAmount = document.getElementById('discount').value;

      const rows = document.querySelectorAll('#itemsBody tr');
      let items = [];
      let subtotal = 0;
      let mainTotal = 0;

      rows.forEach((row, index) => {
        const part = row.querySelector('.partNumber').value;
        const desc = row.querySelector('.description').value;
        const qty = parseFloat(row.querySelector('.qty').value);
        const price = parseFloat(row.querySelector('.price').value);
        const total = qty * price;
        const vat = total * 0.05;
        const inclVat = total + vat;
        subtotal += inclVat;
        mainTotal += total;

        items.push([
          index + 1, part, desc, qty, price.toFixed(2), total.toFixed(2),
          vat.toFixed(2), inclVat.toFixed(2)
        ]);
      });

      const discount = parseInt(discountAmount) || 0;
      const netAmount = mainTotal - discount;//((discount/100)*mainTotal);
      const vatAmount = netAmount * 0.05;
      const grandTotal = netAmount + vatAmount;

      /*const logoInput = document.getElementById('logoInput');
      if (logoInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imgData = e.target.result;
          doc.addImage(imgData, 'PNG', 10, 10, 40, 20);
          drawContent();
        };
        reader.readAsDataURL(logoInput.files[0]);
      } else {*/
        drawContent();
      //}

      function drawContent() {
        doc.setFillColor(197,28,20);
        doc.rect(14,6.6, 180, 3.2, 'F'); 
        //doc.setFontSize(18);
        //doc.text("TAX INVOICE", 105, 20, null, null, 'center');
        
        const img0 = document.getElementById('logo0');

        const canvas0 = document.createElement('canvas');
        canvas0.width = img0.width;
        canvas0.height = img0.height;
        const ctx0 = canvas0.getContext('2d');
        ctx0.drawImage(img0, 0, 0);
        const imgData0 = canvas0.toDataURL('image/png'); // Base64 string
  
        // Add to PDF
        doc.addImage(imgData0, 'PNG', 14, 5, 70, 40); // x, y, width, height


        doc.setFontSize(14).setFont(undefined,'bold');
        doc.text("TAX INVOICE", 150, 25);
        doc.text("TRN: 105031158600003", 130, 35);
        
        

        doc.setFontSize(12).setFont(undefined,'bold');

        doc.setTextColor(0,0,0);
        doc.text('MAX',14,50);

        const maxWidth = doc.getTextWidth('MAX')

        doc.setTextColor(139,0,0);
        doc.text('FORCE',14+maxWidth,50);

        const maxWidth2 = doc.getTextWidth('MAXFORCE');

        doc.setTextColor(0,0,0);
        doc.text(' AUTO SPARE PARTS TRADING LLC',14+maxWidth2,50);
       /* doc.text(`Invoice #: ${invoice.number}`, 10, 65);
        doc.text(`Date: ${invoice.date}`, 80, 65);
        doc.text(`Customer Code: ${invoice.code}`, 140, 65);*/

        doc.setFontSize(10);

        const tableBody = items.map((item, index) => ([
          index + 1,
          item[1],
          item[2],
          item[3],
          item[4],
          item[5],
          item[6],
          item[7]
        ]));


        const amountInWords = toAEDWords(grandTotal);


        tableBody.push(
          [{ content: '', colSpan: 5, rowSpan: 4, styles: { halign: 'left',valign: 'middle', fontStyle: 'bold' } }, {content: 'Total', colSpan: 2, styles: {fillColor: [150,54,52], textColor: 255, cellPadding: 4} }, `${mainTotal.toFixed(2)}`],
          [ {content: 'Discount',colSpan: 2, styles: {fillColor: [150,54,52], textColor: 255, cellPadding: 4} }, `${discount.toFixed(2)}`],
          [ {content: 'Taxable Amount', colSpan: 2,  styles: {fillColor: [150,54,52], textColor: 255, cellPadding: 4} }, `${netAmount.toFixed(2)}`],
          [ {content: 'Tax 5%', colSpan: 2, styles: {fillColor: [150,54,52], textColor: 255, cellPadding: 4} }, `${vatAmount.toFixed(2)}`],
          [ {content: `${amountInWords}`,colSpan: 5, styles: {fillColor: [150,54,52], textColor: 255} },{content: `Net Amount`,colSpan: 2, styles: {fillColor: [150,54,52], textColor: 255, cellPadding: 4} }, `${grandTotal.toFixed(2)}`]
        );   
        
        doc.autoTable({
          startY: 55,
          body: [
            ['Dubai - UAE', {content: 'Inv Date', styles: {fillColor: [150,54,52], textColor: 255} }, {content: 'Inv No', styles: {fillColor: [150,54,52], textColor: 255} }],
            ['Tel : 00971 507881776 ',`${invoice.date}`,`${invoice.number}`],
            ['Email : myfns5@gmail.com ',{content: 'Customer Id', styles: {fillColor: [150,54,52], textColor: 255} },{content: 'Due Date', styles: {fillColor: [150,54,52], textColor: 255} }],
            ['',`${invoice.code}`,`${invoice.invoiceDueDate}`]
          ],
          theme: 'grid',
          styles: { fontSize: 8, lineWidth: 0.3, lineColor: [0,0,0]},
          columnStyles: {
            0: { cellWidth: 'wrap' }
          },
          tableLineWidth: 0.3,
          tableLineColor: [0,0,0]
        });

        doc.autoTable({
          startY: doc.lastAutoTable.finalY,
          head: [['Customer']],
          body: [
            ['Name: ' + customer.name],
            ['Address: ' + customer.address],
            ['Telephone: ' + customer.phone],
            ['Email: ' + (customer.email || '')],
            ['TRN: ' + customer.trn]
          ],
          theme: 'grid',
          styles: { fontSize: 8, lineWidth: 0.3, lineColor: [0,0,0], overflow: 'linebreak'},
          headStyles: {
            fillColor: [150,54,52],
            textColor: 255,
            halign: 'left'
          },
          columnStyles: {
            0: { cellWidth: 'wrap' }
          },
          tableWidth:  90,
          tableLineWidth: 0.3,
          tableLineColor: [0,0,0]
        });
        
        

        doc.autoTable({
          startY: doc.lastAutoTable.finalY,
          head: [[
            'No', 'Code', 'Description', 'Qty', 'Price',
            'Total', 'VAT 5%', 'Net'
          ]],
          body: tableBody,
          theme: 'grid',
          styles: { fontSize: 8, lineWidth: 0.3, lineColor: [0,0,0]},
          headStyles: {
            fillColor: [150,54,52], // light red (approx. 75% red)
            textColor: 255,             // white text
            halign: 'center',
            valign: 'middle',
            cellPadding: { top: 4, bottom: 4 } 
          },
          columnStyles: {
            6: { halign: 'right' },
            7: { halign: 'right', fontStyle: 'bold' }
          },
          tableLineWidth: 0.3,
          tableLineColor: [0,0,0],
          didDrawCell: function (data) {
            // Target the large cell in the first footer row
            if (data.row.index === items.length && data.column.index === 0) {
              const img = document.getElementById('stamp'); // Replace with your actual image ID
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const imgData = canvas.toDataURL('image/png');

              // Calculate position inside the cell
              const x = data.cell.x + 25;
              const y = data.cell.y + 2;
              const width = 40;
              const height = 40; // Because rowSpan = 4

              doc.addImage(imgData, 'PNG', x, y, width, height);
            }
          }

        });

        doc.setFontSize(10);
        doc.setFont(undefined,'bold');

        const finalX = doc.lastAutoTable.settings.margin.left;
        const finalY = doc.lastAutoTable.finalY + 20;
        //doc.text("Customer Signature: ___________________________", 20, finalY);
        // Example: Place "Receiver Sign" above the line
        const label = "Receiver Sign";
        const rightLabel = "MAXFORCE AUTO SPARE PARTS TRADING LLC"
        const line = "__ __ __ __ __ __ __ __ __ __ __ __ ";
        const line2 = "__ __ __ __ __ __ __ __ __ __ __ __ __ __ __ __ __";

        // X and Y coordinates
        const x = 10;
        const y = finalY;
        const gap = 100;

        // First draw the label slightly above
        doc.text(label, finalX+10, y);

        // Then draw the dashed line below it (adjust Y by ~6â€“8 points)
        doc.text(line, finalX, y + 1);

        doc.text(rightLabel, finalX + gap, y);
        doc.text(line2, finalX + gap, y+1);

        const img1 = document.getElementById('logo1');

        const canvas1 = document.createElement('canvas');
        canvas1.width = img1.width;
        canvas1.height = img1.height;
        const ctx1 = canvas1.getContext('2d');
        ctx1.drawImage(img1, 0, 0);
        const imgData1 = canvas1.toDataURL('image/png'); // Base64 string

        // Add to PDF
        doc.addImage(imgData1, 'PNG', finalX, finalY+16, 15, 10); // x, y, width, height

        ///////////////////////

        const img2 = document.getElementById('logo2');

        const canvas2 = document.createElement('canvas');
        canvas2.width = img2.width;
        canvas2.height = img2.height;
        const ctx2 = canvas2.getContext('2d');
        ctx2.drawImage(img2, 0, 0);
        const imgData2 = canvas2.toDataURL('image/png'); // Base64 string

        // Add to PDF
        doc.addImage(imgData2, 'PNG', finalX+20, finalY+16, 20, 10); // x, y, width, height

        ///////////////////////

        const img3 = document.getElementById('logo3');

        const canvas3 = document.createElement('canvas');
        canvas3.width = img3.width;
        canvas3.height = img3.height;
        const ctx3 = canvas3.getContext('2d');
        ctx3.drawImage(img3, 0, 0);
        const imgData3 = canvas3.toDataURL('image/png'); // Base64 string

        // Add to PDF
        doc.addImage(imgData3, 'PNG', finalX+45, finalY+16, 15, 10); // x, y, width, height


         ///////////////////////

         const img4 = document.getElementById('logo4');

         const canvas4 = document.createElement('canvas');
         canvas4.width = img4.width;
         canvas4.height = img4.height;
         const ctx4 = canvas4.getContext('2d');
         ctx4.drawImage(img4, 0, 0);
         const imgData4 = canvas4.toDataURL('image/png'); // Base64 string
 
         // Add to PDF
         doc.addImage(imgData4, 'PNG', finalX+65, finalY+16, 25, 10); // x, y, width, height


          ///////////////////////

          const img5 = document.getElementById('logo5');

          const canvas5 = document.createElement('canvas');
          canvas5.width = img5.width;
          canvas5.height = img5.height;
          const ctx5 = canvas5.getContext('2d');
          ctx5.drawImage(img5, 0, 0);
          const imgData5 = canvas5.toDataURL('image/png'); // Base64 string
  
          // Add to PDF
          doc.addImage(imgData5, 'PNG', finalX+95, finalY+16, 15, 10); // x, y, width, height


           ///////////////////////

           const img6 = document.getElementById('logo6');

           const canvas6 = document.createElement('canvas');
           canvas6.width = img6.width;
           canvas6.height = img6.height;
           const ctx6 = canvas6.getContext('2d');
           ctx6.drawImage(img6, 0, 0);
           const imgData6 = canvas6.toDataURL('image/png'); // Base64 string
   
           // Add to PDF
           doc.addImage(imgData6, 'PNG', finalX+115, finalY+16, 15, 10); // x, y, width, height

           ///////////////////////

           const img7 = document.getElementById('logo7');

           const canvas7 = document.createElement('canvas');
           canvas7.width = img7.width;
           canvas7.height = img7.height;
           const ctx7 = canvas7.getContext('2d');
           ctx7.drawImage(img7, 0, 0);
           const imgData7 = canvas7.toDataURL('image/png'); // Base64 string
   
           // Add to PDF
           doc.addImage(imgData7, 'PNG', finalX+135, finalY+16, 15, 10); // x, y, width, height


            ///////////////////////

            const img8 = document.getElementById('logo8');

            const canvas8 = document.createElement('canvas');
            canvas8.width = img8.width;
            canvas8.height = img8.height;
            const ctx8 = canvas8.getContext('2d');
            ctx8.drawImage(img8, 0, 0);
            const imgData8 = canvas8.toDataURL('image/png'); // Base64 string
    
            // Add to PDF
            doc.addImage(imgData8, 'PNG', finalX+155, finalY+16, 15, 10); // x, y, width, height



        doc.save(`${invoice.number || 'Generated'}_Invoice_${invoice.date}_${customer.name}.pdf`);
      }
    }
  </script>
</body>
</html>
